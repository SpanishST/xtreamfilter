<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XtreamFilter</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #00d4ff;
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-size: 0.9em;
        }
        
        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }
        
        select {
            cursor: pointer;
        }
        
        select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .hint {
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .btn-danger {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }
        
        .btn-danger:hover {
            background: #ff4757;
            color: #fff;
        }
        
        .btn-sm {
            padding: 6px 15px;
            font-size: 0.85em;
        }
        
        .url-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.95em;
            word-break: break-all;
            border: 1px solid rgba(0, 212, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .url-box code {
            color: #00d4ff;
            flex: 1;
        }
        
        .copy-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            background: #00d4ff;
            color: #000;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        
        /* Filter Builder */
        .filter-builder {
            display: grid;
            grid-template-columns: 120px 150px 1fr 100px auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }
        
        .filter-builder .form-group {
            margin-bottom: 0;
        }
        
        .filter-builder input,
        .filter-builder select {
            padding: 10px 12px;
        }
        
        /* Filter List */
        .filter-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        
        .filter-item:last-child {
            margin-bottom: 0;
        }
        
        .filter-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .filter-item .type {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .filter-item .type.include {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }
        
        .filter-item .type.exclude {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        .filter-item .match {
            color: #888;
            font-size: 0.85em;
            min-width: 100px;
        }
        
        .filter-item .value {
            flex: 1;
            font-family: monospace;
            color: #fff;
            word-break: break-all;
        }
        
        .filter-item .delete-btn {
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2em;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .filter-item .delete-btn:hover {
            opacity: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
            color: #00d4ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Quick Add */
        .quick-add {
            margin-top: 15px;
        }
        
        .quick-add-title {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }
        
        .quick-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .quick-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.95em;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .quick-item:last-child {
            border-bottom: none;
        }
        
        .quick-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        .quick-item .add-icon {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .quick-buttons {
            display: flex;
            gap: 5px;
        }
        
        .quick-buttons button {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.1s;
        }
        
        .quick-buttons button:hover {
            transform: scale(1.1);
        }
        
        .btn-include {
            background: #2ecc71;
            color: white;
        }
        
        .btn-exclude {
            background: #e74c3c;
            color: white;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .preview-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        .preview-box .stats-line {
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        .preview-box .channel-list {
            color: #888;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: #00d4ff;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-close:hover {
            color: #fff;
        }
        
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Browser controls */
        .browser-controls {
            display: grid;
            grid-template-columns: 200px 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .browser-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .browser-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }
        
        .browser-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .browser-item:last-child {
            border-bottom: none;
        }
        
        .browser-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .browser-item .item-icon {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .browser-item .item-info {
            flex: 1;
            min-width: 0;
        }
        
        .browser-item .item-name {
            color: #fff;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .browser-item .item-group {
            color: #888;
            font-size: 0.8em;
            margin-top: 2px;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #888;
            font-size: 0.9em;
        }
        
        .pagination button {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button:not(:disabled):hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .group-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 4px;
            font-size: 0.75em;
            color: #00d4ff;
            margin-left: 10px;
        }
        
        @media (max-width: 900px) {
            .filter-builder {
                grid-template-columns: 1fr 1fr;
            }
            
            .filter-builder .form-group:nth-child(3) {
                grid-column: 1 / -1;
            }
            
            .filter-builder .form-group:nth-child(4),
            .filter-builder .form-group:nth-child(5) {
                grid-column: span 1;
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .card {
                padding: 15px;
            }
            
            .filter-builder {
                grid-template-columns: 1fr;
            }
            
            .filter-builder .form-group {
                grid-column: 1;
            }
        }

        .top-nav { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; padding: 12px 20px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; flex-wrap: wrap; }
        .top-nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #00d4ff; font-weight: 700; font-size: 1.15em; white-space: nowrap; }
        .top-nav-brand:hover { color: #33ddff; }
        .top-nav-links { display: flex; gap: 4px; flex-wrap: wrap; margin-left: auto; }
        .top-nav-link { padding: 8px 16px; border-radius: 8px; background: transparent; border: 1px solid transparent; color: #888; text-decoration: none; font-size: 0.9em; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; position: relative; white-space: nowrap; }
        .top-nav-link:hover { color: #fff; background: rgba(255, 255, 255, 0.08); }
        .top-nav-link.active { color: #00d4ff; background: rgba(0, 212, 255, 0.12); border-color: rgba(0, 212, 255, 0.25); }
        .nav-cart-badge { position: absolute; top: 2px; right: 2px; background: #ff4757; color: #fff; font-size: 0.65em; font-weight: 700; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
        .nav-version { font-size: 0.7em; padding: 3px 10px; border-radius: 12px; background: rgba(255, 255, 255, 0.08); color: #888; cursor: default; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="top-nav">
            <a href="/" class="top-nav-brand">üì∫ XtreamFilter</a>
            <span id="version-badge" class="nav-version" style="display:none"></span>
            <div class="top-nav-links">
                <a href="/" class="top-nav-link active">‚öôÔ∏è Settings</a>
                <a href="/browse" class="top-nav-link">üîç Browse</a>
                <a href="/cart" class="top-nav-link">üõí Cart<span class="nav-cart-badge" id="cart-badge" style="display:none">0</span></a>
                <a href="/monitor" class="top-nav-link">üì° Monitor</a>
            </div>
        </nav>
        
        <!-- Cache Status Card -->
        <div class="card">
            <h2>üóÑÔ∏è Cache Status</h2>
            <div class="stats" id="cache-stats">
                <div class="stat-item">
                    <div class="stat-value" id="cache-live">-</div>
                    <div class="stat-label">Live Streams</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-vod">-</div>
                    <div class="stat-label">Movies</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-series">-</div>
                    <div class="stat-label">Series</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-status">-</div>
                    <div class="stat-label">Status</div>
                </div>
            </div>
            
            <!-- Progress bar (hidden by default) -->
            <div id="refresh-progress-container" style="display: none; margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span id="refresh-progress-step" style="color: #00d4ff; font-size: 0.85em;">Initializing...</span>
                    <span id="refresh-progress-percent" style="color: #2ed573; font-size: 0.85em;">0%</span>
                </div>
                <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                    <div id="refresh-progress-bar" style="background: linear-gradient(90deg, #00d4ff, #2ed573); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div style="margin-top: 5px; color: #888; font-size: 0.8em;">
                    Source <span id="refresh-progress-source">0</span> of <span id="refresh-progress-total">0</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <span style="color: #888; font-size: 0.85em;">Last refresh: <span id="cache-last-refresh">Never</span></span>
                <span style="color: #888; font-size: 0.85em;">| TTL: <span id="cache-ttl">-</span>s</span>
                <button type="button" class="btn btn-secondary btn-sm" onclick="refreshCache()" id="refresh-cache-btn">üîÑ Refresh Now</button>
                <button type="button" class="btn btn-sm" onclick="cancelRefresh()" id="cancel-refresh-btn" style="display: none; background: #dc3545;">‚úï Cancel</button>
                <button type="button" class="btn btn-sm" onclick="clearCache()" id="clear-cache-btn" style="background: #ff6b6b;">üóëÔ∏è Clear Cache</button>
            </div>
        </div>
        
        <!-- Connection URLs Card -->
        <div class="card">
            <h2>üîó Connection URLs</h2>
            <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">
                Use these URLs to connect your IPTV app. The merged endpoint combines all sources with unique IDs.
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Merged API (Recommended) -->
                <div style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 10px; padding: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="background: #00d4ff; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold;">RECOMMENDED</span>
                        <strong style="color: #00d4ff;">Merged API (All Sources)</strong>
                    </div>
                    <p style="color: #aaa; font-size: 0.85em; margin-bottom: 10px;">Combines all sources into one unified playlist with no ID conflicts.</p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <code id="merged-api-url" style="flex: 1; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 0.85em; overflow-x: auto; white-space: nowrap;">Loading...</code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyToClipboard('merged-api-url')" title="Copy">üìã</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #888; font-size: 0.8em; min-width: 80px;">M3U Playlist:</span>
                            <code id="merged-m3u-url" style="flex: 1; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 0.85em; overflow-x: auto; white-space: nowrap;">Loading...</code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyToClipboard('merged-m3u-url')" title="Copy">üìã</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #888; font-size: 0.8em; min-width: 80px;">EPG/XMLTV:</span>
                            <code id="merged-epg-url" style="flex: 1; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-size: 0.85em; overflow-x: auto; white-space: nowrap;">Loading...</code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyToClipboard('merged-epg-url')" title="Copy">üìã</button>
                        </div>
                    </div>
                </div>
                
                <!-- Per-Source Routes -->
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px;">
                    <strong style="color: #ccc;">Per-Source Routes</strong>
                    <p style="color: #888; font-size: 0.85em; margin: 10px 0;">Access individual sources directly (uses original IDs).</p>
                    <div id="source-urls-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <span style="color: #666; font-style: italic;">Configure a route for each source to see URLs here.</span>
                    </div>
                </div>
                
                <!-- Proxy Status -->
                <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <span style="color: #888;">Stream Proxying:</span>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="proxy-enabled-toggle" onchange="toggleProxyMode(this.checked)" style="width: 18px; height: 18px;">
                        <span id="proxy-status-label" style="color: #2ed573;">Enabled</span>
                    </label>
                    <span style="color: #666; font-size: 0.8em;">(When enabled, all streams pass through this server)</span>
                </div>
                
                <!-- Telegram Notifications -->
                <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                    <span style="color: #888;">üì± Telegram Notifications:</span>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="openTelegramModal()">‚öôÔ∏è Configure</button>
                    <span style="color: #666; font-size: 0.8em;">(Get notified when automatic categories find new items)</span>
                </div>
                
                <!-- Refresh Interval -->
                <div style="display: flex; align-items: center; gap: 15px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; flex-wrap: wrap;">
                    <span style="color: #888;">üîÑ Auto-Refresh Interval:</span>
                    <select id="refresh-interval-select" onchange="updateRefreshInterval(this.value)" style="padding: 6px 12px; border-radius: 6px; background: #2a2a2a; color: #fff; border: 1px solid #444;">
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                        <option value="900">15 minutes</option>
                        <option value="1800">30 minutes</option>
                        <option value="3600">1 hour</option>
                        <option value="7200">2 hours</option>
                        <option value="14400">4 hours</option>
                        <option value="21600">6 hours</option>
                        <option value="43200">12 hours</option>
                        <option value="86400">24 hours</option>
                    </select>
                    <span style="color: #666; font-size: 0.8em;">(How often the cache is automatically refreshed)</span>
                </div>
            </div>
        </div>

        <!-- Sources Card -->
        <div class="card">
            <h2>üì° Sources</h2>
            <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">
                Configure multiple Xtream sources. Each source can have its own filters and optional group prefix.
            </p>
            
            <div id="sources-list">
                <!-- Sources will be rendered here by JavaScript -->
            </div>
            
            <button type="button" class="btn btn-primary" onclick="addNewSource()" style="margin-top: 15px;">
                ‚ûï Add New Source
            </button>
        </div>
        
        <!-- Content Types Card -->
        <form method="POST" action="/save">
            <div class="card">
                <h2>Content Types</h2>
                <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="content_live" {% if config.content_types.live %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>üì∫ Live TV</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="content_vod" {% if config.content_types.vod %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>üé¨ Movies (VOD)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="content_series" {% if config.content_types.series %}checked{% endif %} style="width: 18px; height: 18px;">
                        <span>üì∫ TV Series</span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary btn-sm" style="margin-top: 15px;">Save Settings</button>
            </div>
        </form>
        
        <!-- Filters Card - Now per source -->
        <div class="card">
            <h2>Filter Rules</h2>
            <p style="color: #888; font-size: 0.9em; margin-bottom: 15px;">
                Filters are configured per source. Select a source to edit its filters.
            </p>
            
            <!-- Source Selector for filters -->
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Select Source</label>
                <select id="filter-source-select" onchange="onFilterSourceChange()">
                    <option value="">-- Select a source --</option>
                </select>
            </div>
            
            <div id="filter-editor-container" style="display: none;">
            
            <!-- Content Type Selector -->
            <div class="tabs" style="margin-bottom: 15px;">
                <div class="tab active" onclick="switchCategory('live')">üì∫ Live TV</div>
                <div class="tab" onclick="switchCategory('vod')">üé¨ Movies</div>
                <div class="tab" onclick="switchCategory('series')">üì∫ Series</div>
            </div>
            
            <!-- Filter Type Tabs -->
            <div class="tabs" id="filter-type-tabs">
                <div class="tab active" onclick="switchTab('groups')">üìÅ Group Filters</div>
                <div class="tab" onclick="switchTab('channels')">üì∫ Channel/Name Filters</div>
            </div>
            
            <!-- Group Filters Tab -->
            <div id="tab-groups" class="tab-content active">
                <div class="filter-builder">
                    <div class="form-group">
                        <label>Action</label>
                        <select id="group-type">
                            <option value="exclude">Exclude</option>
                            <option value="include">Include Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Match Type</label>
                        <select id="group-match">
                            <option value="contains">Contains</option>
                            <option value="not_contains">Not Contains</option>
                            <option value="starts_with">Starts With</option>
                            <option value="ends_with">Ends With</option>
                            <option value="exact">Exact Match</option>
                            <option value="regex">Regex</option>
                            <option value="all">All (Match Everything)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <input type="text" id="group-value" placeholder="e.g., AR|, ADULT, XXX">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="group-case">
                            <span style="font-size: 0.85em;">Case</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addFilter('groups')">Add</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="addExcludeAllFilter('groups')" title="Exclude all groups, then use Include rules to whitelist">‚õî Exclude All Groups</button>
                </div>
                
                <div class="filter-list" id="groups-filters-list">
                    <div class="empty-state">No group filters configured</div>
                </div>
                
                <div class="quick-add">
                    <div class="quick-add-title">Quick Add - Browse available groups:</div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="openGroupsBrowser()">üìÅ Browse Groups</button>
                </div>
            </div>
            
            <!-- Channel Filters Tab -->
            <div id="tab-channels" class="tab-content">
                <div class="filter-builder">
                    <div class="form-group">
                        <label>Action</label>
                        <select id="channel-type">
                            <option value="exclude">Exclude</option>
                            <option value="include">Include Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Match Type</label>
                        <select id="channel-match">
                            <option value="contains">Contains</option>
                            <option value="not_contains">Not Contains</option>
                            <option value="starts_with">Starts With</option>
                            <option value="ends_with">Ends With</option>
                            <option value="exact">Exact Match</option>
                            <option value="regex">Regex</option>
                            <option value="all">All (Match Everything)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <input type="text" id="channel-value" placeholder="e.g., TEST, XXX, 18+">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="channel-case">
                            <span style="font-size: 0.85em;">Case</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addFilter('channels')">Add</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="addExcludeAllFilter('channels')" title="Exclude all channels, then use Include rules to whitelist">‚õî Exclude All Channels</button>
                </div>
                
                <div class="filter-list" id="channels-filters-list">
                    <div class="empty-state">No channel filters configured</div>
                </div>
                
                <div class="quick-add">
                    <div class="quick-add-title">Search and browse channels:</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="channel-search" placeholder="Type to search..." onkeyup="searchChannels(this.value)" style="flex: 1;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openBrowser()">üìã Browse All</button>
                    </div>
                    <div class="quick-list" id="channels-list" style="display: none; margin-top: 10px;"></div>
                </div>
            </div>
            
            </div><!-- End filter-editor-container -->
        </div>
        
        <!-- Preview Card -->
        <div class="card">
            <h2>Preview</h2>
            <button type="button" class="btn btn-secondary btn-sm" onclick="loadPreview()">üîÑ Refresh Preview</button>
            <div class="preview-box" id="preview-box">
                <div class="loading">Click refresh to see filtered playlist preview</div>
            </div>
            
            <div class="actions">
                <a href="/playlist.m3u" class="btn btn-primary" target="_blank">üì• Download Playlist</a>
                <a href="/playlist.m3u" class="btn btn-secondary" target="_blank">üëÅÔ∏è View Raw M3U</a>
            </div>
        </div>
    </div>
    
    <!-- Telegram Settings Modal -->
    <div class="modal" id="telegram-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>üì± Telegram Notifications</h3>
                <button class="modal-close" onclick="closeTelegramModal()">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="color: #aaa; margin-bottom: 20px;">
                    Get notified when automatic categories find new items during cache refresh.
                </p>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="telegram-enabled" style="width: auto;">
                        <span>Enable Telegram Notifications</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>Bot Token</label>
                    <input type="password" id="telegram-bot-token" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <small style="color: #888;">Create a bot via <a href="https://t.me/BotFather" target="_blank" style="color: #4a9eff;">@BotFather</a> to get a token</small>
                </div>
                
                <div class="form-group">
                    <label>Chat ID</label>
                    <input type="text" id="telegram-chat-id" placeholder="-1001234567890 or your user ID">
                    <small style="color: #888;">Use <a href="https://t.me/userinfobot" target="_blank" style="color: #4a9eff;">@userinfobot</a> to get your ID, or a group/channel ID</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="testTelegramNotification()">üîî Test</button>
                    <button class="btn btn-primary" onclick="saveTelegramSettings()">üíæ Save</button>
                </div>
                
                <div id="telegram-status" style="margin-top: 15px; display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Groups Browser Modal -->
    <div class="modal" id="groups-browser-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>üìÅ Browse Groups - <span id="groups-browser-type-label">Live TV</span></h3>
                <button class="modal-close" onclick="closeGroupsBrowser()">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <input type="text" id="groups-search" placeholder="üîç Search groups..." onkeyup="filterGroupsList()" style="width: 100%;">
                </div>
                <div class="quick-list" id="groups-browser-list" style="max-height: 450px;">
                    <div class="loading">Loading groups...</div>
                </div>
                <div style="margin-top: 15px; color: #888; font-size: 0.85em;">
                    <span id="groups-count">0</span> groups found. Click ‚úì to include or ‚úó to exclude.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Channel Browser Modal -->
    <div class="modal" id="browser-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì∫ Browse <span id="browser-type-label">Channels</span></h3>
                <button class="modal-close" onclick="closeBrowser()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="browser-controls">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Filter by Group</label>
                        <select id="browser-group-filter" onchange="loadBrowserItems()">
                            <option value="">All Groups</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Search</label>
                        <input type="text" id="browser-search" placeholder="Search by name..." onkeyup="debounceBrowserSearch()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary btn-sm" onclick="loadBrowserItems()">üîÑ</button>
                    </div>
                </div>
                <div class="browser-list" id="browser-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="pagination">
                    <button onclick="browserPrevPage()" id="browser-prev">‚Üê Prev</button>
                    <span id="browser-page-info">Page 1 of 1</span>
                    <button onclick="browserNextPage()" id="browser-next">Next ‚Üí</button>
                    <span style="margin-left: 15px;">Total: <strong id="browser-total">0</strong></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <select id="browser-action-type">
                        <option value="exclude">Exclude Selected</option>
                        <option value="include">Include Selected</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="applyBrowserSelection()">Apply</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Current category state
        let currentCategory = 'live';
        let currentSourceId = null;  // Currently selected source for filter editing
        let sourcesData = [];  // All sources
        let filtersData = { live: {groups: [], channels: []}, vod: {groups: [], channels: []}, series: {groups: [], channels: []} };
        // Track refresh polling interval
        let refreshPollInterval = null;
        
        // Load sources, filters and cache status on page load
        loadSources();
        loadCacheStatus();
        checkVersion();
        
        // Refresh cache status every 30 seconds (when not actively refreshing)
        setInterval(() => {
            if (!refreshPollInterval) {
                loadCacheStatus();
            }
        }, 30000);
        
        // ============================================
        // SOURCE MANAGEMENT
        // ============================================
        
        function loadSources() {
            fetch('/api/sources')
                .then(r => r.json())
                .then(data => {
                    sourcesData = data.sources || [];
                    renderSources();
                    renderConnectionInfo();
                    updateFilterSourceSelect();
                })
                .catch(() => {});
        }
        
        function renderSources() {
            const container = document.getElementById('sources-list');
            if (sourcesData.length === 0) {
                container.innerHTML = '<div class="empty-state">No sources configured. Add a source to get started.</div>';
                return;
            }
            
            let html = '';
            for (const source of sourcesData) {
                const statusIcon = source.enabled ? '‚úÖ' : '‚è∏Ô∏è';
                const prefixBadge = source.prefix ? `<span class="group-badge">Prefix: ${source.prefix}</span>` : '';
                const routeBadge = source.route ? `<span class="group-badge" style="background: #1a5e3d;">Route: /${source.route}/</span>` : '';
                html += `
                    <div class="source-item" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #00d4ff;">${statusIcon} ${source.name || 'Unnamed'}</strong>
                                ${prefixBadge}
                                ${routeBadge}
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-secondary btn-sm" onclick="editSource('${source.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSource('${source.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="color: #888; font-size: 0.85em;">
                            ${source.host || 'No host configured'}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function renderConnectionInfo() {
            const baseUrl = window.location.origin;
            
            // Update merged URLs
            document.getElementById('merged-api-url').textContent = `${baseUrl}/merged/player_api.php?username=USER&password=PASS`;
            document.getElementById('merged-m3u-url').textContent = `${baseUrl}/playlist.m3u`;
            document.getElementById('merged-epg-url').textContent = `${baseUrl}/merged/xmltv.php`;
            
            // Update per-source URLs
            const sourceUrlsContainer = document.getElementById('source-urls-list');
            const sourcesWithRoutes = sourcesData.filter(s => s.route);
            
            if (sourcesWithRoutes.length === 0) {
                sourceUrlsContainer.innerHTML = '<span style="color: #666; font-style: italic;">Configure a route for each source to see URLs here.</span>';
            } else {
                let sourceHtml = '';
                for (const source of sourcesWithRoutes) {
                    const apiUrl = `${baseUrl}/${source.route}/player_api.php`;
                    sourceHtml += `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #00d4ff; font-size: 0.85em; min-width: 120px;">${source.name || source.route}:</span>
                            <code id="source-url-${source.id}" style="flex: 1; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; font-size: 0.8em; overflow-x: auto; white-space: nowrap;">${apiUrl}</code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyToClipboard('source-url-${source.id}')" title="Copy">üìã</button>
                        </div>
                    `;
                }
                sourceUrlsContainer.innerHTML = sourceHtml;
            }
            
            // Load proxy status
            loadProxyStatus();
            
            // Load refresh interval
            loadRefreshInterval();
        }
        
        function loadProxyStatus() {
            fetch('/api/options/proxy')
                .then(r => r.json())
                .then(data => {
                    const enabled = data.proxy_enabled !== false;
                    document.getElementById('proxy-enabled-toggle').checked = enabled;
                    document.getElementById('proxy-status-label').textContent = enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('proxy-status-label').style.color = enabled ? '#2ed573' : '#ff6b6b';
                })
                .catch(() => {});
        }
        
        function toggleProxyMode(enabled) {
            fetch('/api/options/proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(r => r.json())
            .then(data => {
                const isEnabled = data.proxy_enabled !== false;
                document.getElementById('proxy-status-label').textContent = isEnabled ? 'Enabled' : 'Disabled';
                document.getElementById('proxy-status-label').style.color = isEnabled ? '#2ed573' : '#ff6b6b';
            })
            .catch(() => {});
        }
        
        function loadRefreshInterval() {
            fetch('/api/options/refresh_interval')
                .then(r => r.json())
                .then(data => {
                    const interval = data.refresh_interval || 3600;
                    document.getElementById('refresh-interval-select').value = interval;
                })
                .catch(() => {});
        }
        
        function updateRefreshInterval(value) {
            fetch('/api/options/refresh_interval', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_interval: parseInt(value) })
            })
            .then(r => r.json())
            .catch(() => {});
        }
        
        function updateFilterSourceSelect() {
            const select = document.getElementById('filter-source-select');
            let html = '<option value="">-- Select a source --</option>';
            for (const source of sourcesData) {
                html += `<option value="${source.id}">${source.name || source.id}</option>`;
            }
            select.innerHTML = html;
        }
        
        function onFilterSourceChange() {
            const sourceId = document.getElementById('filter-source-select').value;
            const container = document.getElementById('filter-editor-container');
            
            if (sourceId) {
                currentSourceId = sourceId;
                container.style.display = 'block';
                loadSourceFilters(sourceId);
            } else {
                currentSourceId = null;
                container.style.display = 'none';
            }
        }
        
        function loadSourceFilters(sourceId) {
            fetch(`/api/sources/${sourceId}/filters`)
                .then(r => r.json())
                .then(data => {
                    filtersData = data.filters || { live: {groups: [], channels: []}, vod: {groups: [], channels: []}, series: {groups: [], channels: []} };
                    renderCurrentFilters();
                })
                .catch(() => {});
        }
        
        function addNewSource() {
            const name = prompt('Enter source name:', 'New Source');
            if (!name) return;
            
            fetch('/api/sources', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: name })
            })
            .then(r => r.json())
            .then(data => {
                if (data.source) {
                    editSource(data.source.id);
                }
                loadSources();
            });
        }
        
        function editSource(sourceId) {
            const source = sourcesData.find(s => s.id === sourceId);
            if (!source) return;
            
            // Create a simple edit modal/form
            const html = `
                <div class="modal active" id="source-edit-modal" onclick="if(event.target===this)closeSourceEdit()">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Edit Source</h3>
                            <button class="modal-close" onclick="closeSourceEdit()">‚úï</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div class="form-group">
                                <label>Source Name</label>
                                <input type="text" id="edit-source-name" value="${source.name || ''}">
                            </div>
                            <div class="form-group">
                                <label>Server URL</label>
                                <input type="text" id="edit-source-host" value="${source.host || ''}" placeholder="http://example.com:8080">
                            </div>
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="edit-source-username" value="${source.username || ''}">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="edit-source-password" value="${source.password || ''}">
                            </div>
                            <div class="form-group">
                                <label>Group Prefix (optional)</label>
                                <input type="text" id="edit-source-prefix" value="${source.prefix || ''}" placeholder="e.g., [Source1] ">
                                <div class="hint">Prefix added to all group names from this source</div>
                            </div>
                            <div class="form-group">
                                <label>Max Connections</label>
                                <input type="number" id="edit-source-max-connections" value="${source.max_connections ?? 1}" min="1" style="max-width: 120px;">
                                <div class="hint">Maximum simultaneous streams allowed by this provider. Used to warn when playing while downloading.</div>
                            </div>
                            <div class="form-group">
                                <label>Dedicated Route <span style="color: #ff6b6b;">*</span></label>
                                <input type="text" id="edit-source-route" value="${source.route || ''}" placeholder="e.g., smarters" required>
                                <div class="hint">This source will be available at /<em>route</em>/player_api.php</div>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="edit-source-enabled" ${source.enabled ? 'checked' : ''} style="width: 18px; height: 18px;">
                                    <span>Source Enabled</span>
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="saveSourceEdit('${sourceId}')">Save</button>
                                <button class="btn btn-secondary" onclick="closeSourceEdit()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeSourceEdit() {
            const modal = document.getElementById('source-edit-modal');
            if (modal) modal.remove();
        }
        
        function saveSourceEdit(sourceId) {
            const route = document.getElementById('edit-source-route').value.trim();
            if (!route) {
                alert('Route is required!');
                return;
            }
            
            const data = {
                name: document.getElementById('edit-source-name').value,
                host: document.getElementById('edit-source-host').value,
                username: document.getElementById('edit-source-username').value,
                password: document.getElementById('edit-source-password').value,
                prefix: document.getElementById('edit-source-prefix').value,
                route: route,
                enabled: document.getElementById('edit-source-enabled').checked,
                max_connections: parseInt(document.getElementById('edit-source-max-connections').value, 10) || 1
            };
            
            fetch(`/api/sources/${sourceId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(() => {
                closeSourceEdit();
                loadSources();
            });
        }
        
        function deleteSource(sourceId) {
            if (!confirm('Are you sure you want to delete this source?')) return;
            
            fetch(`/api/sources/${sourceId}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(() => {
                    loadSources();
                    // Clear filter editor if this was the selected source
                    if (currentSourceId === sourceId) {
                        document.getElementById('filter-source-select').value = '';
                        onFilterSourceChange();
                    }
                });
        }
        
        function copyToClipboard(elementId) {
            const url = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }
        
        function loadCacheStatus() {
            fetch('/api/cache/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('cache-live').textContent = data.counts.live_streams || 0;
                    document.getElementById('cache-vod').textContent = data.counts.vod_streams || 0;
                    document.getElementById('cache-series').textContent = data.counts.series || 0;
                    document.getElementById('cache-ttl').textContent = data.ttl_seconds || 3600;
                    
                    const progressContainer = document.getElementById('refresh-progress-container');
                    
                    // Status indicator
                    let status = '‚è≥';
                    if (data.refresh_in_progress) {
                        status = 'üîÑ';
                        document.getElementById('refresh-cache-btn').disabled = true;
                        document.getElementById('refresh-cache-btn').textContent = '‚è≥ Refreshing...';
                        document.getElementById('cancel-refresh-btn').style.display = 'inline-block';
                        
                        // Show and update progress bar
                        progressContainer.style.display = 'block';
                        const progress = data.refresh_progress || {};
                        const percent = Math.min(progress.percent || 0, 100);
                        document.getElementById('refresh-progress-bar').style.width = percent + '%';
                        document.getElementById('refresh-progress-percent').textContent = percent + '%';
                        document.getElementById('refresh-progress-step').textContent = progress.current_step || 'Processing...';
                        document.getElementById('refresh-progress-source').textContent = progress.current_source || 0;
                        document.getElementById('refresh-progress-total').textContent = progress.total_sources || 0;
                        
                        // Start fast polling if not already running
                        if (!refreshPollInterval) {
                            refreshPollInterval = setInterval(loadCacheStatus, 1000);
                        }
                    } else if (data.cache_valid) {
                        status = '‚úÖ';
                        document.getElementById('refresh-cache-btn').disabled = false;
                        document.getElementById('refresh-cache-btn').textContent = 'üîÑ Refresh Now';
                        document.getElementById('cancel-refresh-btn').style.display = 'none';
                        progressContainer.style.display = 'none';
                        // Stop fast polling
                        if (refreshPollInterval) {
                            clearInterval(refreshPollInterval);
                            refreshPollInterval = null;
                        }
                    } else {
                        status = '‚ö†Ô∏è';
                        document.getElementById('refresh-cache-btn').disabled = false;
                        document.getElementById('refresh-cache-btn').textContent = 'üîÑ Refresh Now';
                        document.getElementById('cancel-refresh-btn').style.display = 'none';
                        progressContainer.style.display = 'none';
                        // Stop fast polling
                        if (refreshPollInterval) {
                            clearInterval(refreshPollInterval);
                            refreshPollInterval = null;
                        }
                    }
                    document.getElementById('cache-status').textContent = status;
                    
                    // Last refresh time
                    if (data.last_refresh) {
                        const lastTime = new Date(data.last_refresh);
                        const now = new Date();
                        const diffMinutes = Math.floor((now - lastTime) / 60000);
                        if (diffMinutes < 1) {
                            document.getElementById('cache-last-refresh').textContent = 'Just now';
                        } else if (diffMinutes < 60) {
                            document.getElementById('cache-last-refresh').textContent = diffMinutes + ' min ago';
                        } else {
                            const diffHours = Math.floor(diffMinutes / 60);
                            document.getElementById('cache-last-refresh').textContent = diffHours + 'h ' + (diffMinutes % 60) + 'm ago';
                        }
                    } else {
                        document.getElementById('cache-last-refresh').textContent = 'Never';
                    }
                })
                .catch(() => {});
        }
        
        function refreshCache() {
            document.getElementById('refresh-cache-btn').disabled = true;
            document.getElementById('refresh-cache-btn').textContent = '‚è≥ Starting...';
            document.getElementById('refresh-progress-container').style.display = 'block';
            document.getElementById('refresh-progress-bar').style.width = '0%';
            document.getElementById('refresh-progress-percent').textContent = '0%';
            document.getElementById('refresh-progress-step').textContent = 'Starting...';
            
            fetch('/api/cache/refresh', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('refresh-cache-btn').textContent = '‚è≥ Refreshing...';
                    // Poll for completion every second
                    const pollInterval = setInterval(() => {
                        fetch('/api/cache/status')
                            .then(r => r.json())
                            .then(status => {
                                loadCacheStatus();
                                if (!status.refresh_in_progress) {
                                    clearInterval(pollInterval);
                                }
                            });
                    }, 1000);
                })
                .catch(() => {
                    document.getElementById('refresh-cache-btn').disabled = false;
                    document.getElementById('refresh-cache-btn').textContent = 'üîÑ Refresh Now';
                    document.getElementById('cancel-refresh-btn').style.display = 'none';
                    document.getElementById('refresh-progress-container').style.display = 'none';
                });
        }
        
        function cancelRefresh() {
            if (!confirm('Cancel the current refresh? Use this if the refresh appears stuck.')) return;
            
            fetch('/api/cache/cancel-refresh', { method: 'POST' })
                .then(r => r.json())
                .then(() => {
                    document.getElementById('refresh-cache-btn').disabled = false;
                    document.getElementById('refresh-cache-btn').textContent = 'üîÑ Refresh Now';
                    document.getElementById('cancel-refresh-btn').style.display = 'none';
                    document.getElementById('refresh-progress-container').style.display = 'none';
                    if (refreshPollInterval) {
                        clearInterval(refreshPollInterval);
                        refreshPollInterval = null;
                    }
                    loadCacheStatus();
                })
                .catch(() => {});
        }
        
        function clearCache() {
            if (!confirm('Clear all cached data? This will remove all cached streams and categories. A refresh will be needed to fetch data again.')) return;
            
            document.getElementById('clear-cache-btn').disabled = true;
            document.getElementById('clear-cache-btn').textContent = '‚è≥ Clearing...';
            
            fetch('/api/cache/clear', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('clear-cache-btn').disabled = false;
                    document.getElementById('clear-cache-btn').textContent = 'üóëÔ∏è Clear Cache';
                    loadCacheStatus();
                    alert('Cache cleared successfully!');
                })
                .catch(() => {
                    document.getElementById('clear-cache-btn').disabled = false;
                    document.getElementById('clear-cache-btn').textContent = 'üóëÔ∏è Clear Cache';
                    alert('Failed to clear cache');
                });
        }
        
        function switchCategory(category) {
            currentCategory = category;
            
            // Update category tabs
            const categoryTabs = document.querySelectorAll('.tabs')[0].querySelectorAll('.tab');
            categoryTabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Refresh displayed filters for new category
            renderCurrentFilters();
            
            // Clear quick-add lists
            document.getElementById('groups-list').style.display = 'none';
            document.getElementById('channels-list').style.display = 'none';
        }
        
        function switchTab(tab) {
            // Update filter type tabs only (second set of tabs)
            const filterTypeTabs = document.getElementById('filter-type-tabs').querySelectorAll('.tab');
            filterTypeTabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
        }
        

        
        function loadFilters() {
            // This is now handled by loadSourceFilters when a source is selected
            // Keep for backward compatibility, but do nothing
        }
        
        function renderCurrentFilters() {
            const catFilters = filtersData[currentCategory] || {groups: [], channels: []};
            renderFilters('groups', catFilters.groups || []);
            renderFilters('channels', catFilters.channels || []);
        }
        
        function renderFilters(target, filters) {
            const container = document.getElementById(target + '-filters-list');
            
            if (!container) {
                console.error('Container not found:', target + '-filters-list');
                return;
            }
            
            const categoryLabels = {live: 'Live TV', vod: 'Movies', series: 'Series'};
            const categoryLabel = categoryLabels[currentCategory] || currentCategory;
            
            if (!filters || filters.length === 0) {
                container.innerHTML = '<div class="empty-state">No ' + target + ' filters for ' + categoryLabel + '</div>';
                return;
            }
            
            const matchLabels = {
                'contains': 'contains',
                'not_contains': 'not contains',
                'starts_with': 'starts with',
                'ends_with': 'ends with',
                'exact': 'equals',
                'regex': 'regex',
                'all': '‚õî ALL'
            };
            
            container.innerHTML = filters.map((f, i) => {
                const isAll = f.match === 'all';
                const valueDisplay = isAll ? '(everything)' : escapeHtml(f.value) + (f.case_sensitive ? ' (case)' : '');
                return `
                <div class="filter-item" style="${isAll ? 'background: rgba(255,71,87,0.2); border-color: #ff4757;' : ''}">
                    <span class="type ${f.type}">${f.type}</span>
                    <span class="match">${matchLabels[f.match] || f.match}</span>
                    <span class="value">${valueDisplay}</span>
                    <button class="delete-btn" onclick="deleteFilter('${target}', ${i})">‚úï</button>
                </div>
            `}).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function addExcludeAllFilter(target) {
            if (!currentSourceId) {
                alert('Please select a source first');
                return;
            }
            
            if (!confirm(`This will exclude ALL ${target}. You can then use "Include Only" rules to whitelist specific items. Continue?`)) {
                return;
            }
            
            fetch(`/api/sources/${currentSourceId}/filters/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category: currentCategory,
                    target: target,
                    type: 'exclude',
                    match: 'all',
                    value: '*',
                    case_sensitive: false
                })
            })
            .then(r => r.json())
            .then(data => {
                filtersData = data.filters;
                renderCurrentFilters();
            });
        }
        
        function addFilter(target) {
            if (!currentSourceId) {
                alert('Please select a source first');
                return;
            }
            
            const type = document.getElementById(target.slice(0, -1) + '-type').value;
            const match = document.getElementById(target.slice(0, -1) + '-match').value;
            let value = document.getElementById(target.slice(0, -1) + '-value').value.trim();
            const caseSensitive = document.getElementById(target.slice(0, -1) + '-case').checked;
            
            // For "all" match type, value is not required
            if (match === 'all') {
                value = '*';
            } else if (!value) {
                alert('Please enter a value');
                return;
            }
            
            fetch(`/api/sources/${currentSourceId}/filters/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category: currentCategory,
                    target: target,
                    type: type,
                    match: match,
                    value: value,
                    case_sensitive: caseSensitive
                })
            })
            .then(r => r.json())
            .then(data => {
                filtersData = data.filters;
                renderCurrentFilters();
                document.getElementById(target.slice(0, -1) + '-value').value = '';
            });
        }
        
        function deleteFilter(target, index) {
            if (!currentSourceId) return;
            
            fetch(`/api/sources/${currentSourceId}/filters/delete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category: currentCategory,
                    target: target,
                    index: index
                })
            })
            .then(r => r.json())
            .then(data => {
                filtersData = data.filters;
                renderCurrentFilters();
            });
        }
        
        function quickAddGroup(group, filterType) {
            document.getElementById('group-type').value = filterType;
            document.getElementById('group-match').value = 'exact';
            document.getElementById('group-value').value = group;
            addFilter('groups');
        }
        
        // Groups Browser Modal
        let allGroupsData = [];
        
        function openGroupsBrowser() {
            if (!currentSourceId) {
                alert('Please select a source first');
                return;
            }
            
            const categoryLabels = {live: 'Live TV', vod: 'Movies', series: 'Series'};
            document.getElementById('groups-browser-type-label').textContent = categoryLabels[currentCategory] || currentCategory;
            document.getElementById('groups-browser-modal').classList.add('active');
            document.getElementById('groups-search').value = '';
            loadGroupsForBrowser();
        }
        
        function closeGroupsBrowser() {
            document.getElementById('groups-browser-modal').classList.remove('active');
        }
        
        function loadGroupsForBrowser() {
            const list = document.getElementById('groups-browser-list');
            list.innerHTML = '<div class="loading">Loading groups...</div>';
            
            const sourceParam = currentSourceId ? `&source_id=${currentSourceId}` : '';
            fetch('/groups?type=' + currentCategory + sourceParam)
                .then(r => r.json())
                .then(data => {
                    allGroupsData = data.groups || [];
                    document.getElementById('groups-count').textContent = allGroupsData.length;
                    renderGroupsList(allGroupsData);
                })
                .catch(() => {
                    list.innerHTML = '<div class="loading">Error loading groups</div>';
                });
        }
        
        function filterGroupsList() {
            const search = document.getElementById('groups-search').value.toLowerCase();
            const filtered = allGroupsData.filter(g => g.toLowerCase().includes(search));
            document.getElementById('groups-count').textContent = filtered.length;
            renderGroupsList(filtered);
        }
        
        function renderGroupsList(groups) {
            const list = document.getElementById('groups-browser-list');
            
            if (groups.length === 0) {
                list.innerHTML = '<div class="loading">No groups found</div>';
                return;
            }
            
            list.innerHTML = groups.map(g => {
                const escapedGroup = g.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `<div class="quick-item">
                    <span style="flex: 1; word-break: break-word;">${escapeHtml(g)}</span>
                    <span class="quick-buttons" style="flex-shrink: 0;">
                        <button class="btn-include" onclick="quickAddGroupFromBrowser('${escapedGroup}', 'include')" title="Include Only">‚úì</button>
                        <button class="btn-exclude" onclick="quickAddGroupFromBrowser('${escapedGroup}', 'exclude')" title="Exclude">‚úó</button>
                    </span>
                </div>`;
            }).join('');
        }
        
        function quickAddGroupFromBrowser(group, filterType) {
            if (!currentSourceId) {
                alert('Please select a source first');
                return;
            }
            
            fetch(`/api/sources/${currentSourceId}/filters/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category: currentCategory,
                    target: 'groups',
                    type: filterType,
                    match: 'exact',
                    value: group,
                    case_sensitive: false
                })
            })
            .then(r => r.json())
            .then(data => {
                filtersData = data.filters;
                renderCurrentFilters();
                // Visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úî';
                btn.style.background = '#27ae60';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1000);
            });
        }
        
        function loadGroups() {
            // Deprecated - now using openGroupsBrowser()
            openGroupsBrowser();
        }
        
        let searchTimeout;
        function searchChannels(query) {
            clearTimeout(searchTimeout);
            const list = document.getElementById('channels-list');
            
            if (query.length < 2) {
                list.style.display = 'none';
                return;
            }
            
            list.style.display = 'block';
            list.innerHTML = '<div class="loading">Searching...</div>';
            
            searchTimeout = setTimeout(() => {
                fetch('/channels?type=' + currentCategory + '&search=' + encodeURIComponent(query) + '&per_page=50')
                    .then(r => r.json())
                    .then(data => {
                        if (data.items && data.items.length > 0) {
                            list.innerHTML = data.items.map(item => 
                                `<div class="quick-item">
                                    <span>${escapeHtml(item.name)}<span class="group-badge">${escapeHtml(item.group)}</span></span>
                                    <span class="quick-buttons">
                                        <button class="btn-include" onclick="quickAddChannel('${item.name.replace(/'/g, "\\'")}', 'include')" title="Include">‚úì</button>
                                        <button class="btn-exclude" onclick="quickAddChannel('${item.name.replace(/'/g, "\\'")}', 'exclude')" title="Exclude">‚úó</button>
                                    </span>
                                </div>`
                            ).join('');
                            if (data.total > data.items.length) {
                                list.innerHTML += `<div class="loading" style="padding: 10px;">Showing ${data.items.length} of ${data.total} results</div>`;
                            }
                        } else {
                            list.innerHTML = '<div class="loading">No channels found</div>';
                        }
                    })
                    .catch(() => {
                        list.innerHTML = '<div class="loading">Error searching channels</div>';
                    });
            }, 300);
        }
        
        function quickAddChannel(channel, filterType) {
            document.getElementById('channel-type').value = filterType;
            document.getElementById('channel-match').value = 'exact';
            document.getElementById('channel-value').value = channel;
            addFilter('channels');
        }
        
        function loadPreview() {
            const box = document.getElementById('preview-box');
            box.innerHTML = '<div class="loading">Generating preview...</div>';
            
            fetch('/preview')
                .then(r => r.json())
                .then(data => {
                    let html = `<div class="stats-line">${data.stats || 'No stats available'}</div>`;
                    html += '<div class="channel-list">';
                    if (data.sample_channels && data.sample_channels.length > 0) {
                        html += '<strong>Sample channels:</strong><br>';
                        html += data.sample_channels.map(c => escapeHtml(c)).join('<br>');
                    }
                    html += '</div>';
                    box.innerHTML = html;
                })
                .catch(() => {
                    box.innerHTML = '<div class="loading">Error loading preview</div>';
                });
        }
        
        // ============================================
        // CHANNEL BROWSER
        // ============================================
        
        let browserPage = 1;
        let browserTotalPages = 1;
        let browserSearchTimeout;
        let browserItemsCache = [];
        
        function openBrowser() {
            document.getElementById('browser-modal').classList.add('active');
            browserPage = 1;
            document.getElementById('browser-search').value = '';
            
            // Update label based on current category
            const labels = {live: 'Live Channels', vod: 'Movies', series: 'Series'};
            document.getElementById('browser-type-label').textContent = labels[currentCategory] || 'Channels';
            
            // Load groups for filter dropdown
            loadBrowserGroups();
            loadBrowserItems();
        }
        
        function closeBrowser() {
            document.getElementById('browser-modal').classList.remove('active');
        }
        
        function loadBrowserGroups() {
            const select = document.getElementById('browser-group-filter');
            select.innerHTML = '<option value="">Loading...</option>';
            
            fetch('/api/browse?type=' + currentCategory + '&per_page=1')
                .then(r => r.json())
                .then(data => {
                    let options = '<option value="">All Groups</option>';
                    if (data.groups && data.groups.length > 0) {
                        options += data.groups.map(g => 
                            `<option value="${escapeHtml(g.name)}">${escapeHtml(g.name)} (${g.count})</option>`
                        ).join('');
                    }
                    select.innerHTML = options;
                })
                .catch(() => {
                    select.innerHTML = '<option value="">All Groups</option>';
                });
        }
        
        function debounceBrowserSearch() {
            clearTimeout(browserSearchTimeout);
            browserSearchTimeout = setTimeout(() => {
                browserPage = 1;
                loadBrowserItems();
            }, 300);
        }
        
        function loadBrowserItems() {
            const list = document.getElementById('browser-list');
            list.innerHTML = '<div class="loading">Loading...</div>';
            
            const search = document.getElementById('browser-search').value;
            const group = document.getElementById('browser-group-filter').value;
            
            const params = new URLSearchParams({
                type: currentCategory,
                page: browserPage,
                per_page: 50,
                search: search,
                group: group
            });
            
            fetch('/api/browse?' + params.toString())
                .then(r => r.json())
                .then(data => {
                    browserTotalPages = data.total_pages || 1;
                    browserItemsCache = data.items || [];
                    
                    // Update pagination info
                    document.getElementById('browser-page-info').textContent = 
                        `Page ${data.page} of ${browserTotalPages}`;
                    document.getElementById('browser-total').textContent = data.total || 0;
                    document.getElementById('browser-prev').disabled = data.page <= 1;
                    document.getElementById('browser-next').disabled = data.page >= browserTotalPages;
                    
                    if (browserItemsCache.length === 0) {
                        list.innerHTML = '<div class="loading">No items found</div>';
                        return;
                    }
                    
                    list.innerHTML = browserItemsCache.map((item, i) => `
                        <div class="browser-item">
                            <input type="checkbox" data-index="${i}" data-name="${escapeHtml(item.name)}">
                            ${item.icon ? `<img src="${item.icon}" class="item-icon" onerror="this.style.display='none'">` : ''}
                            <div class="item-info">
                                <div class="item-name">${escapeHtml(item.name)}</div>
                                <div class="item-group">${escapeHtml(item.group)}</div>
                            </div>
                            <span class="quick-buttons">
                                <button class="btn-include" onclick="addSingleBrowserItem('${escapeAttr(item.name)}', 'include')" title="Include">‚úì</button>
                                <button class="btn-exclude" onclick="addSingleBrowserItem('${escapeAttr(item.name)}', 'exclude')" title="Exclude">‚úó</button>
                            </span>
                        </div>
                    `).join('');
                })
                .catch(() => {
                    list.innerHTML = '<div class="loading">Error loading items</div>';
                });
        }
        
        function escapeAttr(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        }
        
        function browserPrevPage() {
            if (browserPage > 1) {
                browserPage--;
                loadBrowserItems();
            }
        }
        
        function browserNextPage() {
            if (browserPage < browserTotalPages) {
                browserPage++;
                loadBrowserItems();
            }
        }
        
        function addSingleBrowserItem(name, filterType) {
            addFilterDirectly('channels', filterType, 'exact', name);
        }
        
        function addFilterDirectly(target, type, match, value) {
            fetch('/api/filters/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category: currentCategory,
                    target: target,
                    type: type,
                    match: match,
                    value: value,
                    case_sensitive: false
                })
            })
            .then(r => r.json())
            .then(data => {
                filtersData = data.filters;
                renderCurrentFilters();
            });
        }
        
        function applyBrowserSelection() {
            const checkboxes = document.querySelectorAll('#browser-list input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one item');
                return;
            }
            
            const filterType = document.getElementById('browser-action-type').value;
            const names = Array.from(checkboxes).map(cb => cb.dataset.name);
            
            // Add filters one by one (could be optimized with batch API)
            let promise = Promise.resolve();
            names.forEach(name => {
                promise = promise.then(() => 
                    fetch('/api/filters/add', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            category: currentCategory,
                            target: 'channels',
                            type: filterType,
                            match: 'exact',
                            value: name,
                            case_sensitive: false
                        })
                    }).then(r => r.json())
                );
            });
            
            promise.then(() => {
                loadFilters();
                closeBrowser();
            });
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBrowser();
                closeTelegramModal();
            }
        });
        
        // Close modal on backdrop click
        document.getElementById('browser-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBrowser();
            }
        });
        
        document.getElementById('telegram-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTelegramModal();
            }
        });
        
        // Handle Enter key in filter inputs
        document.querySelectorAll('.filter-builder input[type="text"]').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const target = this.id.includes('group') ? 'groups' : 'channels';
                    addFilter(target);
                }
            });
        });
        
        // ============================================
        // TELEGRAM NOTIFICATIONS
        // ============================================
        
        function openTelegramModal() {
            document.getElementById('telegram-modal').classList.add('active');
            loadTelegramSettings();
        }
        
        function closeTelegramModal() {
            document.getElementById('telegram-modal').classList.remove('active');
            document.getElementById('telegram-status').style.display = 'none';
        }
        
        function loadTelegramSettings() {
            fetch('/api/config/telegram')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('telegram-enabled').checked = data.enabled || false;
                    document.getElementById('telegram-chat-id').value = data.chat_id || '';
                    // Don't populate token field for security, show placeholder if set
                    const tokenField = document.getElementById('telegram-bot-token');
                    if (data.bot_token_masked) {
                        tokenField.placeholder = `Current: ${data.bot_token_masked}`;
                    }
                })
                .catch(() => {});
        }
        
        function saveTelegramSettings() {
            const enabled = document.getElementById('telegram-enabled').checked;
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            const payload = {
                enabled: enabled,
                chat_id: chatId
            };
            
            // Only include bot_token if user entered a new one
            if (botToken) {
                payload.bot_token = botToken;
            }
            
            fetch('/api/config/telegram', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                showTelegramStatus('success', 'Settings saved successfully!');
                // Clear the token field and reload to show masked version
                document.getElementById('telegram-bot-token').value = '';
                loadTelegramSettings();
            })
            .catch(() => {
                showTelegramStatus('error', 'Failed to save settings');
            });
        }
        
        function testTelegramNotification() {
            showTelegramStatus('info', 'Sending test notification...');
            
            fetch('/api/config/telegram/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(r => r.json().then(data => ({status: r.status, data})))
            .then(({status, data}) => {
                if (status === 200) {
                    showTelegramStatus('success', data.message);
                } else {
                    showTelegramStatus('error', data.message);
                }
            })
            .catch(() => {
                showTelegramStatus('error', 'Failed to send test notification');
            });
        }
        
        function showTelegramStatus(type, message) {
            const statusEl = document.getElementById('telegram-status');
            statusEl.style.display = 'block';
            statusEl.style.padding = '10px';
            statusEl.style.borderRadius = '4px';
            
            if (type === 'success') {
                statusEl.style.background = 'rgba(34, 197, 94, 0.2)';
                statusEl.style.color = '#22c55e';
            } else if (type === 'error') {
                statusEl.style.background = 'rgba(239, 68, 68, 0.2)';
                statusEl.style.color = '#ef4444';
            } else {
                statusEl.style.background = 'rgba(59, 130, 246, 0.2)';
                statusEl.style.color = '#3b82f6';
            }
            
            statusEl.textContent = message;
        }
        function checkVersion() {
            fetch('/api/version').then(r => r.json()).then(data => {
                const badge = document.getElementById('version-badge');
                if (!badge) return;
                if (data.update_available) {
                    badge.textContent = 'v' + data.current + ' ‚Üí v' + data.latest;
                    badge.style.background = 'rgba(255, 165, 0, 0.15)';
                    badge.style.color = '#ffa500';
                    badge.style.cursor = 'pointer';
                    badge.title = 'Click to view release notes';
                    badge.onclick = function() { window.open(data.release_url, '_blank'); };
                } else {
                    badge.textContent = 'v' + data.current;
                }
                badge.style.display = 'inline-block';
            }).catch(() => {});
        }
        function updateCartBadge() {
            fetch('/api/cart/status').then(r => r.json()).then(data => {
                const badge = document.getElementById('cart-badge');
                if (!badge) return;
                const count = data.queued + data.downloading;
                if (count > 0) { badge.textContent = count; badge.style.display = 'flex'; }
                else { badge.style.display = 'none'; }
            }).catch(() => {});
        }
        updateCartBadge();
    </script>
</body>
</html>
